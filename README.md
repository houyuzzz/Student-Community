# student-community
牛客社区平台，根据牛客网课程改编成学生社区平台

## 功能具体说明
### 1.登录与注册
登录与注册比较常规，比较注意的是验证码，当进入登录界面，前端通过get请求获得这一次验证码的信息，别添加验证的cookie让浏览器携带好区分这是这一个人输入的验证码（设置过期时间redis和浏览器都要）。登录后会给浏览器cookie中的一个ticket，浏览器每次都带着ticket来请求，服务端获取去和redis中的比对，成功就使用threadlocal去持有这个用户的信息。返回页面结束后就移除这个用户的信息。

如果要保证同一时间只能有一个用户登录呢。（我的想法是维护一个map,键为用户id，值为ticket的。每次浏览器带着ticket来请求，从ticket中取出用户id和map中的比对,如果不同则说明了有人后面登录这个账号，然后把redis中的这个ticket删除，重定向到登录)。

### 2.分页
分页没啥好说的，没用插件，每页显示的数据都是从数据库取一段的数据，通过sql，limit 输入的参数有两个一个是要取数据起始行，一个是取数据的总数。封装了一个page类来维护相关的信息，包含重要字段当前页和每次显示条数，数据起始行就是 （当前-1）*每次显示条数

### 3.贴子与评论
数据库有两张表，一个是帖子表，一个是评论表。评论表的存储有两列分别是实体id和实体类型。当实体类型为1时，实体id存储一个帖子id。这是评论。当实体类型为2时，实体id存储一个评论id，这是楼中楼。页面表示的时候一个是贴子，一个是评论，评论中还有回复。程序用一个List<>是一个map类型，map的value为一个Object。评论list的Object用来放回复list。实现套娃。

### 4.点赞与关注
这两个逻辑很像。点赞。点赞某个帖子或者他的评论回复。 根据实体id和实体类型者两个参数确定点赞的目标（使用redis的set数据类型，redis根据这个为key，存储value是点赞用户id) 。当对一个实体点赞时候。该实体的拥有者也会获得一个赞。拥有者id为key，value加1（用了事务）。查询实体点赞数量，返回size ，查点赞状态看有没有那个人的id，查用户点赞数是直接查数值的。关注也类似，某个人关注一个人，这个人多一个关注另一个人多一个粉丝，因为用的是有序集合，第二个值score存储当前时间，关注列表那里可以用来倒序排列。

### 5.私信与通知
分为私信与通知两部分。
私信某人说明两个人建立一个会话，每个人都有一个会话列表。数据库里面有个message表就是用来存储私信相关的信息。里面有几个重要的字段，一个是from_id这条私信发起者 ， 一个是to_id这条私信接收者。会话id由这两个id拼接而成。查看私信就跟据会话id获取两个人的信息。未读消息由数据库status字段标记。
通知这一部分，关于何时通知，当别人评论你的帖子，别人回复你的评论，别人点赞你的实体（帖子评论），别人关注了你的时候。因为用的是同一张表，这时候from_id变为1，conversation_id为发起通知类型。content字段不在存储字符串，而是存放json字符串包含用户id、实体id、实体类型、帖子id。用来表明是什么类型的信息、发生在什么时候。

### 6.排行榜
采用了spring qurz框架做定时任务。首先排行榜是根据帖子的点赞回帖数量与之成，是否加精正比，与时间成反比。每当帖子有属性改变，评论点赞时置顶加精，就往redis去添加这个id的值（set类型），应用程序定时刷新数据库，从数据库取出计算帖子分数，然后重新排行。

### 7.性能优化
性能优化。做了两点，一个是通过redis缓存了user表的用户数据（优先从redis拿，然后没有就去数据库取在缓存，然后再改变用户数据表的方法删除缓存）。另一个用来本地缓存Caffine,缓存了首页。

### 8.权限管理
采用了springsecurity框架，对用户进行授权。管理员能对帖子进行置顶删除加精。

### 9.搜索
调esAPI,值得注意的是当贴子数值有改动时候，要重新推送帖子数据到es上。

## 项目问题
### 1.BUG
比较多的错就是空指针异常，因为用的tymleaf模板，用模板没有判断为空的语句。
还有一个错误就是aop的时候，对每个业务层的业务加了个写日记的功能，记录谁调用过着业务（ip地址+时间访问了这个业务）。用消息队列产生消息，消息到了后消费者消费消息调用了一个业务，这时后就会出异常。

### 2.trie树的理解
前缀树是一种空间换时间的结构，常用来做过滤敏感词的
结构。时间复杂读为输入字符串的时间复杂度O（n）。
具体思路，首先是构造前缀树，根据读入的敏感词构造成多叉树。有个变量作为判断是否读到树的叶子节点。构造时候为最后一个节点的变量置为真。进行敏感词判断的时候，用两个指针在字符串上移动，另个指针在前缀数移动。
